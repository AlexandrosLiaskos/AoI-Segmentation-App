<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8' />
    <title>AoI Segmentation Tool</title>
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' /> <!-- Added width=device-width -->

    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <!-- Mapbox GL Draw -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.css' type='text/css' />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div id='map'></div>

<div class="controls">
    <!-- Main Title -->
    <h3 class="controls-title">AoI Segmentation Tool</h3>

    <!-- Step 1: Drawing Instructions -->
    <div id="step-draw" class="control-step">
        <h4>1. Draw Area of Interest</h4>
        <p class="instructions">Use the LineString tool (<span class="mapbox-gl-draw_line draw-icon-placeholder"></span>) on the map to draw your AoI boundary.</p>
        <button id="finish-drawing-btn" class="btn btn-primary" disabled>Finish Drawing & Calculate Stats</button>
    </div>

    <!-- Step 2: Finish & Stats -->
    <div id="step-finish" class="control-step" style="display: none;">
        <h4>2. Review & Refine</h4>
        <div id="stats" class="stats-display">
            <!-- Content generated by JS, using dl/dt/dd -->
             <dl>
                <dt>Status:</dt>
                <dd>Not calculated yet.</dd>
            </dl>
        </div>
        <div class="button-group">
            <button id="close-loop-btn" class="btn btn-warning" style="display: none;">Close AoI Loop</button>
            <button id="restart-drawing-btn" class="btn btn-secondary">Restart Drawing</button>
        </div>
    </div>

    <!-- Step 3: Segmentation Options -->
    <div id="step-segment" class="control-step" style="display: none;">
        <hr class="section-divider">
        <h4>3. Configure Segmentation</h4>
        <div class="input-group">
            <label for="buffer-km">Buffer AoI (km):</label>
            <input type="number" id="buffer-km" value="1" min="" step="0.1">
        </div>
        <div class="input-group">
            <label for="grid-area">Target Grid Area (kmÂ²):</label> <!-- Changed label slightly -->
            <input type="number" id="grid-area" value="20" min="0.01" step="0.1"> <!-- Min value adjusted -->
        </div>

        <button id="segment-aoi-btn" class="btn btn-success">Segment AoI</button>

        <div class="checkbox-group">
             <label>
                <input type="checkbox" id="show-original-chk" checked> Show Original AoI
            </label>
            <label>
                <input type="checkbox" id="show-segmented-chk" checked> Show Segmented Grid
            </label>
        </div>
         <div id="download-link" class="download-section">
             <!-- Download link added by JS -->
         </div>
    </div>

    <!-- General Messages -->
    <div id="messages" class="messages-area">
        <!-- Messages added by JS -->
    </div>

</div>

<!-- Pass Mapbox token from Flask -->
<script>
    // JS for token handling remains the same
    try {
        const tokenValue = "{{ mapbox_token }}";
        if (!tokenValue || tokenValue === "YOUR_MAPBOX_ACCESS_TOKEN") {
            console.error("Invalid Mapbox token received from server:", tokenValue);
            window.MAPBOX_ACCESS_TOKEN = '';
        } else {
            window.MAPBOX_ACCESS_TOKEN = tokenValue;
            console.log("Mapbox token successfully loaded");
        }
    } catch (e) {
        console.error("Error setting Mapbox token:", e);
        window.MAPBOX_ACCESS_TOKEN = '';
    }
</script>
<!-- Custom JS -->
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

</body>
</html>